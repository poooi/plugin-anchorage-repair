# 泊地修理插件

[![npm package][npm-badge]][npm]


## 简介
泊地修理插件是辅助明石HP修理和野埼士气提升的工具，两者拥有相似的计时机制：

- [x] 预计泊地修理用时（明石、明石改、朝日改）
- [x] 支持配对修理奖励（明石+朝日改在1-2号位）
- [x] 预计士气提升时机（野埼）
- [x] 泊地修理完成通知
- [x] 支持联合运用（明石+野埼，或明石+朝日改+野埼）

## 限制
- 在改变泊地修理舰队的编成时，由于艦これ API 不会更新舰娘耐久，可能导致修理用时的预计错误。因此必须返回到母港界面来重新计时。

## 简要机制

### 明石的泊地修理（HP回复）
**要求：**
- 明石、明石改或朝日改必须为舰队**旗舰**（1号位）
- **旗舰血量要求**：不能处于中破或更严重的损伤状态（HP必须 > 50% 最大耐久）
- 旗舰不能处于入渠状态
- 基础修理能力：
  - **明石/明石改**：可以修理她自己以及二号位舰娘（基础：2艘），每装备一个舰队修理设施，可以多修理一个位置的舰娘
  - **朝日改**：至少需要一个舰队修理设施才能修理自己（基础：0艘），每装备一个舰队修理设施，可以多修理一个位置的舰娘
- **配对修理奖励**：当明石系列（明石/明石改）和朝日改在1号和2号位时：
  - **有效配对**：明石+朝日改 或 明石改+朝日改（1-2号位任意顺序）
  - **2号位血量要求**：必须为小破未满状态（HP > 75% 最大耐久）才能获得配对奖励
  - 2号位的舰队修理设施也计入修理范围
  - 如果2号位装备了舰队修理设施且血量健康，修理速度提升约15%（时间缩短至85%）
  - 最多5个舰队修理设施时，可修理联合舰队的7艘舰娘
- **修理对象资格**：舰娘必须在小破（HP > 50% 最大耐久）或更好的状态
- 目标舰娘未处于入渠状态

**计时器：** 至少20分钟进行HP修理

### 野埼的士气提升（Cond回复）
**要求：**
- 野埼（或野埼改）必须在**1号位或2号位**以启动计时器
- 15分钟后返回母港时检查资格条件：
  - 野埼补给完成
  - 野埼无损伤至小破以下（HP > 75% 最大耐久）
  - 野埼cond值 ≥ 30
  - 野埼不在远征或入渠中
- 如果符合条件，为除野埼外的所有舰队成员提升士气（cond值）。
- 野埼：每次+2 cond，野埼改：每次+3 cond
- 最大cond值：54
- 目标舰娘：不在入渠中（损伤状态不限）
- 每提升一艘舰娘消耗1燃料

**计时器：** 至少15分钟进行士气提升

### 联合运用
- 两个系统可以在同一舰队中同时工作
- 配置示例：
  - 明石作为旗舰（修理HP，20分钟计时器）+ 野埼在2号位（提升士气，15分钟计时器）
  - 明石/明石改作为旗舰 + 朝日改在2号位 = 配对修理奖励（更快的修理速度，扩展修理范围）
- **计时器行为（按照WIKI）**：
  - **修理计时器（HP）**：所有舰队共享同一计时器（"修理時間のタイマーは共通"）- 当任何舰队有修理舰作为旗舰时，所有舰队共享同一个计时器
  - **士气计时器（野埼）**：所有舰队共享同一计时器
- **配对修理**：当「明石/明石改」与「朝日改」占据1-2号位（任意顺序）时，结合她们的舰队修理设施以扩展范围并加快修理速度

### 入渠时间
基于损失耐久、等级与船类型的公式已经确认，这个值也在 API 的 *api_ndock_time* 中给出。

### 修理时间（明石）
- 需要至少 20 分钟来完成至少 1 格的耐久的回复
- 超过 20 分钟，回复量与入渠状态下的回复量一致，并向下取整
- 入渠时间公式中有 30 秒的额外时间，然而实际入渠过程会提前 1 分钟结束。修理时间则会**向上取整**到下一分钟。

### 计时器重置规则
- **修理计时器（全局/共享）** 在以下情况重置：
  - 改变有修理舰旗舰的舰队编成（包括添加和移除舰娘）
  - 在有修理舰旗舰的舰队中使用高速修复材来进行入渠
  - 使有修理舰旗舰的舰队参加远征
  - 在最小20分钟后返回母港恢复正常
  - **重要**：按照WIKI "修理時間のタイマーは共通"，修理计时器在所有舰队间共享

- **野埼计时器（全局/共享）** 在以下情况重置：
  - 将野埼放置在1号位或2号位（计时器立即启动）
  - 野埼在1/2号位时改变舰队编成且计时器 < 15分钟
  - 从1号位或2号位移除野埼（计时器清除）
  - 15分钟后：编成变更不再重置计时器
  - 注意：远征不会重置野埼计时器（"不在远征中"是资格检查条件，不是重置触发条件）

### 计时器行为（重要！）
- **两个计时器都是全局/共享的**：按照WIKI，修理计时器和野埼计时器都在所有舰队间共享
- **修理计时器**："修理時間のタイマーは共通" - 当任何舰队有修理舰旗舰时，所有舰队共享同一个计时器
- **野埼计时器**："複数の艦隊でそれぞれ野埼を運用する場合でもタイマーは共通" - 野埼计时器在所有舰队间共享
- **15分钟激活后**：编成变更不再重置野埼计时器
- **舰队预设**：载入编成预设不会重置计时器
- **舰娘改造**：舰娘改造不会重置计时器
- **适用范围**：两个系统在所有舰队（1-4）和遊撃部隊（7艘）中都有效

### 插件考虑范围之外的事件
以下情况，插件并未特别进行处理。因此结果可能会与所期望的不同
- 调整明石的装备，准确地说，调整舰队修理设施的数量（针对明石）
- 使舰队参加远征

### 已实现功能
✓ 载入舰队预设不会重置计时器
✓ 野埼计时器在所有舰队间共享
✓ 计时器激活后（野埼15分钟，明石20分钟），编成变更不会重置计时器
✓ 舰娘改造（包括野埼→野埼改）不会重置计时器

# 参考资料
- <http://kancolle.wikia.com/wiki/Akashi#Anchorage_Repair>
- <http://kancolle.wikia.com/wiki/Docking#Repair_time>
- <http://wikiwiki.jp/kancolle/?%CC%C0%C0%D0#h2_content_1_1>
- <https://en.kancollewiki.net/wiki/Auxiliary_Ships_Mechanics>

# 授权许可
MIT

[npm-badge]: https://img.shields.io/npm/v/poi-plugin-anchorage-repair.svg?style=flat-square
[npm]: https://www.npmjs.org/package/poi-plugin-anchorage-repair
